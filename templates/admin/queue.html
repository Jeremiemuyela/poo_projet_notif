{% extends "admin/base.html" %}

{% block title %}Files d'Attente - Administration{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-list-queue"></i> Files d'Attente</h1>
    <button class="btn btn-outline-primary" onclick="refreshQueue()">
        <i class="bi bi-arrow-clockwise"></i> Actualiser
    </button>
</div>

<!-- Statistiques -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" id="stat-pending">-</div>
            <div class="stat-label">En attente</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" id="stat-processing">-</div>
            <div class="stat-label">En traitement</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" id="stat-completed">-</div>
            <div class="stat-label">Terminées</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" id="stat-failed">-</div>
            <div class="stat-label">Échouées</div>
        </div>
    </div>
</div>

<!-- Informations générales -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-info-circle"></i> Informations
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>Workers actifs:</strong> <span id="info-workers">-</span>
            </div>
            <div class="col-md-4">
                <strong>Taille de la file:</strong> <span id="info-queue-size">-</span>
            </div>
            <div class="col-md-4">
                <strong>Total traité:</strong> <span id="info-total-processed">-</span>
            </div>
        </div>
    </div>
</div>

<!-- Liste des tâches -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list-task"></i> Tâches</span>
        <div>
            <select id="filter-status" class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="loadTasks()">
                <option value="">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="processing">En traitement</option>
                <option value="completed">Terminées</option>
                <option value="failed">Échouées</option>
            </select>
            {% if session.user and session.user.role == 'admin' %}
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearCompleted()">
                <i class="bi bi-trash"></i> Nettoyer
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="tasks-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Statut</th>
                        <th>Créée</th>
                        <th>Début</th>
                        <th>Fin</th>
                        <th>Résultat</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> Chargement...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Charger les données au chargement de la page
    document.addEventListener('DOMContentLoaded', async function() {
        await loadQueueData();
        setInterval(loadQueueData, 3000); // Actualiser toutes les 3 secondes
    });
    
    async function loadQueueData() {
        try {
            // Charger les statistiques
            const statsResponse = await apiRequest('/admin/api/queue/stats');
            if (statsResponse.ok && statsResponse.data.success) {
                const stats = statsResponse.data.stats;
                
                document.getElementById('stat-pending').textContent = stats.tasks_by_status.pending;
                document.getElementById('stat-processing').textContent = stats.tasks_by_status.processing;
                document.getElementById('stat-completed').textContent = stats.tasks_by_status.completed;
                document.getElementById('stat-failed').textContent = stats.tasks_by_status.failed;
                
                document.getElementById('info-workers').textContent = stats.workers;
                document.getElementById('info-queue-size').textContent = stats.current_queue_size;
                document.getElementById('info-total-processed').textContent = stats.total_processed;
            }
            
            // Charger les tâches
            await loadTasks();
        } catch (error) {
            console.error('Erreur lors du chargement:', error);
        }
    }
    
    async function loadTasks() {
        try {
            const filter = document.getElementById('filter-status').value;
            let url = '/admin/api/queue/tasks?limit=50';
            if (filter) {
                // Le filtrage se fera côté client pour simplifier
            }
            
            const response = await apiRequest(url);
            if (response.ok && response.data.success) {
                const tasks = response.data.tasks;
                const filterValue = document.getElementById('filter-status').value;
                const filteredTasks = filterValue 
                    ? tasks.filter(t => t.status === filterValue)
                    : tasks;
                
                updateTasksTable(filteredTasks);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des tâches:', error);
        }
    }
    
    function updateTasksTable(tasks) {
        const tbody = document.querySelector('#tasks-table tbody');
        tbody.innerHTML = '';
        
        if (tasks.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="text-center text-muted">Aucune tâche</td>';
            tbody.appendChild(tr);
            return;
        }
        
        tasks.forEach(task => {
            const tr = document.createElement('tr');
            
            const statusBadge = getStatusBadge(task.status);
            const resultCell = task.error 
                ? `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${task.error}</span>`
                : (task.result ? `<span class="text-success"><i class="bi bi-check-circle"></i> Succès</span>` : '-');
            
            tr.innerHTML = `
                <td><code class="small">${task.id.substring(0, 8)}...</code></td>
                <td><span class="badge bg-secondary">${task.type}</span></td>
                <td>${statusBadge}</td>
                <td>${formatDateTime(task.created_at_iso)}</td>
                <td>${task.started_at_iso ? formatDateTime(task.started_at_iso) : '-'}</td>
                <td>${task.completed_at_iso ? formatDateTime(task.completed_at_iso) : '-'}</td>
                <td>${resultCell}</td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function getStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge bg-warning">En attente</span>',
            'processing': '<span class="badge bg-info">En traitement</span>',
            'completed': '<span class="badge bg-success">Terminée</span>',
            'failed': '<span class="badge bg-danger">Échouée</span>'
        };
        return badges[status] || status;
    }
    
    function formatDateTime(value) {
        if (!value) return '-';
        try {
            const date = new Date(value);
            return date.toLocaleString('fr-FR');
        } catch (error) {
            return value;
        }
    }
    
    function refreshQueue() {
        loadQueueData();
        showAlert('Données actualisées', 'success');
    }
    
    async function clearCompleted() {
        if (!confirm('Voulez-vous supprimer les tâches terminées de plus de 24h ?')) {
            return;
        }
        
        try {
            const response = await apiRequest('/admin/api/queue/clear', 'POST', { hours: 24 });
            if (response.ok && response.data.success) {
                showAlert(`${response.data.removed} tâches supprimées`, 'success');
                await loadQueueData();
            } else {
                showAlert('Erreur lors du nettoyage', 'danger');
            }
        } catch (error) {
            showAlert('Erreur: ' + error.message, 'danger');
        }
    }
</script>
{% endblock %}


